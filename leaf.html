<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Leaflet</title>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB1iTarA_znvFNeEXrXInrRjQLKPB0yaKM" async defer></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script src='https://unpkg.com/leaflet.gridlayer.googlemutant@latest/Leaflet.GoogleMutant.js'></script>
    <script src="https://code.jquery.com/jquery-3.0.0.min.js"></script>
    <script src="js/leaflet-heat.js"></script>
  </head>
  <body>
    <div style="width:990px; height:700px; float: left" id="map" ></div>

    <div style="float: left; margin: 100px">
    <form name="form">
      车辆:
      <select name="carid">
        <option value="12014">12014</option>
        <option value="12020">12020</option>
        <option value="12214">12214</option>
        <option value="12233">12233</option>
        <option value="12238">12238</option>
        <option value="12343">12343</option>
        <option value="12412">12412</option>
        <option value="12465">12465</option>
        <option value="12482">12482</option>
        <option value="12788">12788</option>
        <option value="30831">30831</option>
        <option value="30842">30842</option>
        <option value="31174">31174</option>
        <option value="31808">31808</option>
        <option value="33966">33966</option>
        <option value="35531">35531</option>
        <option value="39503">39503</option>
        <option value="32337">32337</option>
        <option value="81812">81812</option>
      </select><br><br>
      线路:<br>
      <input type="text" name="line" value="">

      <br><br>
     起始年月日 时间:<br>
    <input type="text" name="start_datetime" value="2017-03-16 12:00:00">
    <br><br>
      结束年月日 时间:<br>
    <input type="text" name="end_datetime" value="2017-03-16 16:00:00">
    <br>

    </form><br>
      <button id="button_1">查询</button>
      <button id="button_2">站点正向查询</button>
      <button id="button_3">站点反向查询</button><br><br>
      <button id="button_4">速度热力图</button>


    </div>

    <script type='text/javascript'>
      var map = new L.Map('map', {center: new L.LatLng(29.55884,106.53963), zoom: 13});

      var geojsonMarkerOptions = {
          radius: 5,
          fillColor: "#ff7800",
          color: "#000",
          weight: 1,
          opacity: 1,
          fillOpacity: 0.8
      };

      var myStyle = {
          "color": "#27ff40",
          // "weight": 4,
          "opacity": 0.65
      };

      var layer = L.marker([51.5, -0.09]).addTo(map);
      var line = '322';
      var heatmapData = '';
      form.line.value = line;
      function onEachFeature(feature, layer) {
          if (feature.properties && feature.properties.info) {
              layer.bindPopup(feature.properties.info);
              if (feature.properties.line) {
                  line = feature.properties.line;
              }
          }
      }

      $("#button_1").click(function () {
          var url = 'point/'+form.carid.value+'/'+form.start_datetime.value+'/'+form.end_datetime.value;
         $.ajax({
             type: "GET",
             url: url,
             dataType: "json",
             success: function (data) {

                 layer.remove();
                 layer = L.geoJSON(data, {
                      style: myStyle,
                      onEachFeature: onEachFeature,
                      pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng, geojsonMarkerOptions);
                  }});
                  form.line.value=line;
                  layer.addTo(map);
                  // heatmapData = data.features.pop().geometry.coordinates;

                  // var heat = L.heatLayer(heatmapData, {radius: 10 ,minOpacity:1   });
                  // heat.addTo(map);


             }

         })
      });
      $("#button_4").click(function () {
          var url = 'firebase/'+form.carid.value+'/'+form.start_datetime.value+'/'+form.end_datetime.value;
         $.ajax({
             type: "GET",
             url: url,
             dataType: "json",
             success: function (data) {
                  layer.remove();
                  heatmapData = data;
                  layer = L.heatLayer(heatmapData, {radius:7, max:0.001,blur:9});
                  layer.addTo(map);
             }

         })
      });
      var lineLayer1 = L.marker([51.5, -0.09]).addTo(map);
      $("#button_2").click(function () {
         $.ajax({
             type: "GET",
             url: 'line/'+form.line.value+'/0',
             dataType: "json",
             success: function (data) {
                 lineLayer1.remove();
                 lineLayer2.remove();
                 lineLayer1 = L.geoJSON(data, {
                      style: myStyle,
                      onEachFeature: onEachFeature,
                      pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng);
                  }});
                form.line.value=line;
                 lineLayer1.addTo(map);
             }

         })
      });
      var lineLayer2 = L.marker([51.5, -0.09]).addTo(map);
      $("#button_3").click(function () {
         $.ajax({
             type: "GET",
             url: 'line/'+form.line.value+'/1',
             dataType: "json",
             success: function (data) {
                 lineLayer2.remove();
                 lineLayer1.remove();
                 lineLayer2 = L.geoJSON(data, {
                      // style: myStyle,
                      onEachFeature: onEachFeature,
                      pointToLayer: function (feature, latlng) {
                        return L.circleMarker(latlng);
                  }});
                form.line.value=line;
                 lineLayer2.addTo(map);
             }

         })
      });

      var roads = L.gridLayer.googleMutant({
        type: 'satellite' // valid values are 'roadmap', 'satellite', 'terrain' and 'hybrid'
      }).addTo(map);



    </script>
  </body>
</html>